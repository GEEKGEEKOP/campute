<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/persian-datepicker/dist/css/persian-datepicker.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/persian-date@latest/dist/persian-date.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/js/persian-datepicker.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/css/persian-datepicker.min.css">
    <script src="https://unpkg.com/jalaali-js/dist/jalaali.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment-jalaali@0.9.2/build/moment-jalaali.js"></script>
    <title>Ù†Ø±Ù…â€ŒØ§ÙØ²Ø§Ø± Ø­Ø³Ø§Ø¨Ø¯Ø§Ø±ÛŒ</title>
    <style>
/* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ú©Ù„ÛŒ ØµÙØ­Ù‡ */

:root {
    direction: rtl;
    writing-mode: horizontal-tb;
    text-orientation: mixed;
}


body {
    font-family: 'Tajawal', Arial, sans-serif;
    text-align: right;
    background: linear-gradient(135deg, #ece9e6, #ffffff);
    margin: 0;
    padding: 0;
}

.container {
    width: 90%;
    max-width: 600px;
    margin: 50px auto;
    background: white;
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
}

h2 {
    text-align: center;
    font-size: 26px;
    color: #333;
    margin-bottom: 20px;
    font-weight: bold;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
}

/* Ø§Ø³ØªØ§ÛŒÙ„ ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§ */
input[type="text"], input[type="number"] {
    width: 100%;
    padding: 12px;
    font-size: 16px;
    border: 2px solid #ddd;
    border-radius: 8px;
    box-sizing: border-box;
    margin-bottom: 12px;
    transition: 0.3s ease;
    background: #f8f8f8;
}

input[type="text"]:focus, input[type="number"]:focus {
    border-color: #007bff;
    box-shadow: 0 0 8px rgba(0, 123, 255, 0.5);
    background: white;
}

input::placeholder {
    color: #888;
    font-style: italic;
}

/* Ø§Ø³ØªØ§ÛŒÙ„ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ */
button {
    background: linear-gradient(135deg, #007bff, #0056b3);
    color: white;
    padding: 14px;
    font-size: 16px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    width: 100%;
    transition: 0.3s;
    font-weight: bold;
}

button:hover {
    background: linear-gradient(135deg, #0056b3, #003f7f);
}

/* Ø§Ø³ØªØ§ÛŒÙ„ Ø¯Ú©Ù…Ù‡ Ø­Ø°Ù */
.delete-btn {
    background: linear-gradient(135deg, #dc3545, #b21f2d);
    color: white;
    border: none;
    padding: 6px 12px;
    cursor: pointer;
    border-radius: 5px;
    transition: 0.3s;
    font-weight: bold;
}

.delete-btn:hover {
    background: linear-gradient(135deg, #b21f2d, #8b1522);
}

/* Ø§Ø³ØªØ§ÛŒÙ„ Ù†Ù…Ø§ÛŒØ´ Ù„ÛŒØ³Øª Ú©Ø³Ø¨â€ŒÙˆÚ©Ø§Ø± */
.business {
    border: 1px solid #ddd;
    padding: 18px;
    margin-top: 12px;
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    transition: transform 0.3s ease;
}

.business:hover {
    transform: scale(1.03);
}

/* Ø§Ø³ØªØ§ÛŒÙ„ Ù…ØªÙ† ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ */
.log {
    background: #f9f9f9;
    padding: 10px;
    margin-top: 6px;
    border-radius: 6px;
    font-size: 15px;
    font-weight: bold;
    border-left: 4px solid #007bff;
}

/* Ø§Ø³ØªØ§ÛŒÙ„ ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§ */
input[type="text"], input[type="number"] {
    width: 100%;
    padding: 10px;
    font-size: 16px;
    border: 2px solid #ccc;
    border-radius: 5px;
    box-sizing: border-box;
    margin-bottom: 10px;
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
}

/* Ø­Ø§Ù„Øª focus */
input[type="text"]:focus, input[type="number"]:focus {
    border-color: #007bff;
    box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
}

/* Ø§Ø³ØªØ§ÛŒÙ„ Ù…ØªÙ† placeholder */
input::placeholder {
    color: #aaa;
    font-style: italic;
}

/* Ø§Ø³ØªØ§ÛŒÙ„ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ */
button {
    background-color: #007bff;
    color: white;
    padding: 12px 20px;
    font-size: 16px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    width: 100%;
    transition: background-color 0.3s ease;
    margin-top: 10px;
}

button:hover {
    background-color: #0056b3;
}

/* Ø§Ø³ØªØ§ÛŒÙ„ Ø¨Ø±Ø§ÛŒ Ø´Ù…Ø§Ø±Ù‡â€ŒÚ¯Ø°Ø§Ø±ÛŒ */
.input-number {
    text-align: left;
}

/* Ø§Ø³ØªØ§ÛŒÙ„ Ø¯Ú©Ù…Ù‡ Ø­Ø°Ù */
.delete-btn {
    background: #dc3545;
    color: white;
    border: none;
    padding: 5px 10px;
    cursor: pointer;
    border-radius: 3px;
}

.delete-btn:hover {
    background: #c82333;
}

/* Ø§Ø³ØªØ§ÛŒÙ„ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù„ÛŒØ³Øª Ú©Ø³Ø¨â€ŒÙˆÚ©Ø§Ø± */
.business {
    border: 1px solid #ddd;
    padding: 15px;
    margin-top: 10px;
    background: #fff;
    border-radius: 5px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

/* Ø§Ø³ØªØ§ÛŒÙ„ Ø¨Ø±Ø§ÛŒ Ù…ØªÙ† ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ */
.log {
    background: #f9f9f9;
    padding: 8px;
    margin-top: 5px;
    border-radius: 5px;
    font-size: 14px;
}
*/
    #calendarContainer {
      width: 300px;
      margin: 20px auto;
      text-align: center;
    }
    #monthYear {
      margin-bottom: 10px;
      font-size: 1.2em;
      font-weight: bold;
    }
    #calendar {
      width: 100%;
      border-collapse: collapse;
    }
    #calendar th, #calendar td {
      border: 1px solid #ccc;
      padding: 8px;
      height: 40px;
      vertical-align: middle;
    }
    #calendar th {
      background: #f2f2f2;
    }
    /* Ø§Ø³ØªØ§ÛŒÙ„ Ø±ÙˆØ²Ù‡Ø§ÛŒ Ø¹Ù„Ø§Ù…Øªâ€ŒÚ¯Ø°Ø§Ø±ÛŒ Ø´Ø¯Ù‡ */
    .marked {
      background: #4CAF50;
      cursor: pointer;
    }
    .mark {
      background: #F44336;
      cursor: pointer;
    }
    /* Ø§Ø³ØªØ§ÛŒÙ„ Ø±ÙˆØ² Ø§Ù…Ø±ÙˆØ² */
    .today {
      border: 2px solid red;
    }
    /* Ø§Ø³ØªØ§ÛŒÙ„ modal */
    #modalOverlay {
      display: none;
      position: fixed;
      top:0;
      left:0;
      width:100%;
      height:100%;
      background: rgba(0,0,0,0.5);
      z-index: 100;
    }
    #modal {
      display: none;
      position: fixed;
      top: 50%;
      left:50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      z-index: 101;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
    }
    #modal button {
      margin-top: 10px;
    }
    /* Ø§Ø³ØªØ§ÛŒÙ„ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ù†Ø§ÙˆØ¨Ø±ÛŒ */
    .nav-buttons {
      margin: 10px 0;
    }
    .nav-buttons button {
      margin: 0 5px;
      padding: 5px 10px;
    }
    </style>
</head>
<body>
  <div id="calendarContainer" class="container">
    <!-- Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ù†Ø§ÙˆØ¨Ø±ÛŒ Ø¨Ø±Ø§ÛŒ ØªØºÛŒÛŒØ± Ù…Ø§Ù‡ Ùˆ Ø³Ø§Ù„ -->
    <div class="nav-buttons">
      <button onclick="previousYear()">Ø³Ø§Ù„ Ù‚Ø¨Ù„</button>
      <button onclick="previousMonth()">Ù…Ø§Ù‡ Ù‚Ø¨Ù„</button>
      <button onclick="nextMonth()">Ù…Ø§Ù‡ Ø¨Ø¹Ø¯</button>
      <button onclick="nextYear()">Ø³Ø§Ù„ Ø¨Ø¹Ø¯</button>
    </div>
    <h2 id="monthYear"></h2>
    <table id="calendar">
      <thead>
        <tr>
          <th>Ø´</th> <!-- Ø´Ù†Ø¨Ù‡ -->
          <th>ÛŒ</th> <!-- ÛŒÚ©Ø´Ù†Ø¨Ù‡ -->
          <th>Ø¯</th> <!-- Ø¯ÙˆØ´Ù†Ø¨Ù‡ -->
          <th>Ø³</th> <!-- Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡ -->
          <th>Ú†</th> <!-- Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡ -->
          <th>Ù¾</th> <!-- Ù¾Ù†Ø¬Ø´Ù†Ø¨Ù‡ -->
          <th>Ø¬</th> <!-- Ø¬Ù…Ø¹Ù‡ -->
        </tr>
      </thead>
      <tbody id="calendarBody">
      </tbody>
    </table>
  </div>
    <div class="container">
        <h2>Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø³Ø¨â€ŒÙˆÚ©Ø§Ø±Ù‡Ø§</h2>
        <input type="text" id="businessName" placeholder="Ù†Ø§Ù… Ú©Ø³Ø¨â€ŒÙˆÚ©Ø§Ø±">
        <input type="text" id="initialCash" class="input-number" placeholder="Ø³Ø±Ù…Ø§ÛŒÙ‡ Ø§ÙˆÙ„ÛŒÙ‡ " oninput="formatInput(this)">
        <input type="text" id="currencyunit" placeholder="ÙˆØ§Ø­Ø¯ Ù¾ÙˆÙ„ Ú©Ø³Ø¨ Ùˆ Ú©Ø§Ø± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯">
        <button onclick="addBusiness()">Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø³Ø¨â€ŒÙˆÚ©Ø§Ø±</button>
        <div id="businessList"></div>
    </div>
  <!-- overlay Ùˆ modal Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª -->
  <div id="modalOverlay"></div>
  <div id="modal">
    <p id="modalContent"></p>
    <button onclick="closeModal()">Ø¨Ø³ØªÙ†</button>
  </div>


  
    <script>
        let dates=[];
        let dess=[];
        ////////////////////////////////////////////
        let businesses = JSON.parse(localStorage.getItem('businesses')) || [];
        console.log(businesses);
        const parseDate = (dateString) => {
            return new Date(dateString);
        };        
        ///////////////////////////*************************************************************///////////////////////
        function saveData() {
            localStorage.setItem('businesses', JSON.stringify(businesses));
        }
        function formatInput(input) {
            // Ø¬Ø¯Ø§ Ú©Ø±Ø¯Ù† Ø¨Ø®Ø´ ØµØ­ÛŒØ­ Ùˆ Ø§Ø¹Ø´Ø§Ø±ÛŒ
            let parts = input.value.split('.');
            let integerPart = parts[0]; // Ø¨Ø®Ø´ ØµØ­ÛŒØ­
            let decimalPart = parts.length > 1 ? '.' + parts[1] : ''; // Ø¨Ø®Ø´ Ø§Ø¹Ø´Ø§Ø±ÛŒ (Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø´Øª)

            // Ø­Ø°Ù Ú©Ø§Ø±Ø§Ú©ØªØ±Ù‡Ø§ÛŒ ØºÛŒØ± Ø¹Ø¯Ø¯ÛŒ Ø§Ø² Ø¨Ø®Ø´ ØµØ­ÛŒØ­
            integerPart = integerPart.replace(/[^\d]/g, '');

            // Ø§ÙØ²ÙˆØ¯Ù† ÙˆÛŒØ±Ú¯ÙˆÙ„ Ø¨Ù‡ Ø¨Ø®Ø´ ØµØ­ÛŒØ­
            integerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ',');

            // ØªØ±Ú©ÛŒØ¨ Ø¨Ø®Ø´ ØµØ­ÛŒØ­ Ùˆ Ø§Ø¹Ø´Ø§Ø±ÛŒ
            input.value = integerPart + decimalPart;
        }
        function addBusiness() {
            const name = document.getElementById('businessName').value;
            const cash = parseFloat(document.getElementById('initialCash').value.replace(/,/g, '')); // Ø­Ø°Ù ÙˆÛŒØ±Ú¯ÙˆÙ„â€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ Ø¹Ø¯Ø¯
            const currencyunit = document.getElementById('currencyunit').value;
            if (name && !isNaN(cash)) {
                businesses.push({ name, cash, currencyunit,transactions: [] });
                saveData();
                renderBusinesses();
                document.getElementById('businessName').value = '';
                document.getElementById('initialCash').value = '';
            }
        }
        function convertJalaliToGregorian(jalaliDate) {
            return moment(jalaliDate, 'jYYYY/jM/jD').format('YYYY-MM-DD');
        }
        function convertPersianToEnglish(str) {
            return str.replace(/[Û°-Û¹]/g, d => "0123456789"["Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹".indexOf(d)]);
        }
        function addTransaction(index, type) {
            // Ø¯Ø±ÛŒØ§ÙØª Ù…Ù‚Ø§Ø¯ÛŒØ± ÙˆØ±ÙˆØ¯ÛŒ Ø§Ø² ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ú©Ø³Ø¨â€ŒÙˆÚ©Ø§Ø± Ø¨Ø§ Ø§Ù†Ø¯ÛŒØ³ index
            const amountInput = document.getElementById(`transaction-amount-${index}`);
            const descriptionInput = document.getElementById(`transaction-description-${index}`);
            const dateInput = document.getElementById(`transaction-date-${index}`);
        
            let  amount = parseFloat(amountInput.value.replace(/,/g, ''));
            const description = descriptionInput.value.trim();
            // Ø§Ú¯Ø± ÙÛŒÙ„Ø¯ Ø²Ù…Ø§Ù† Ù…Ù‚Ø¯Ø§Ø± Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯ØŒ Ø§Ø² Ø¢Ù† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…ØŒ Ø¯Ø± ØºÛŒØ± Ø§ÛŒÙ† ØµÙˆØ±Øª Ø²Ù…Ø§Ù† ÙØ¹Ù„ÛŒ Ø±Ø§ Ù…ÛŒâ€ŒÚ¯ÛŒØ±ÛŒÙ…
            console.log("*****",dateInput.value);
            console.log("#####",convertPersianToEnglish(dateInput.value));
            console.log("XXXXX",convertJalaliToGregorian(convertPersianToEnglish(dateInput.value)));
            const date = dateInput.value ? new Date(convertJalaliToGregorian(convertPersianToEnglish(dateInput.value))) : new Date();
        
            if (!isNaN(amount) && amount > 0 && description) {
                //businesses[index].cash += type === 'profit' ? amount : -amount;
                amount = type === 'profit' ? amount : -amount;
                businesses[index].transactions.push({ 
                    type, 
                    amount, 
                    description, 
                    date: date.toLocaleString('en-US'), 
                    balance: businesses[index].cash 
                });
                saveData();
                renderBusinesses();
                scrollToBusiness(index);
            } else {
                alert("Ù„Ø·ÙØ§Ù‹ Ù…Ù‚Ø¯Ø§Ø± Ùˆ ØªÙˆØ¶ÛŒØ­Ø§Øª Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯");
            }
        }
        
        function deleteBusiness(index) {
            if (confirm("Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§ÛŒÙ† Ú©Ø³Ø¨â€ŒÙˆÚ©Ø§Ø± Ø±Ø§ Ø­Ø°Ù Ú©Ù†ÛŒØ¯ØŸ")) {
                businesses.splice(index, 1);
                saveData();
                renderBusinesses();
            }
        }
        function formatNumber(number) {
            // Ø§Ø¨ØªØ¯Ø§ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø­Ø§ØµÙ„ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… Ú©Ù‡ ÙˆØ±ÙˆØ¯ÛŒ ÛŒÚ© Ø¹Ø¯Ø¯ Ø§Ø³Øª
            if (isNaN(number)) {
                console.error("The input is not a valid number");
                return;
            }
            let prefix = "";
            if (number < 0){
                prefix="-";
            }
            if (number > 0){
                prefix="+";
            }
            let text = number.toString(); // ØªØ¨Ø¯ÛŒÙ„ Ø¹Ø¯Ø¯ Ø¨Ù‡ Ø±Ø´ØªÙ‡
            let parts = text.split('.');
            let integerPart = parts[0];
            let decimalPart = parts.length > 1 ? '.' + parts[1] : '';

            // Ø­Ø°Ù Ù‡Ù…Ù‡ Ú©Ø§Ø±Ø§Ú©ØªØ±Ù‡Ø§ÛŒ ØºÛŒØ± Ø¹Ø¯Ø¯ÛŒ
            integerPart = integerPart.replace(/[^\d]/g, '');

            // Ø¬Ø¯Ø§ Ú©Ø±Ø¯Ù† Ù‡Ø²Ø§Ø±Ú¯Ø§Ù†
            integerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ',');

            return prefix + integerPart + decimalPart;
        }
        function renderBusinesses() {
            const list = document.getElementById('businessList');
            list.innerHTML = '';
            //let array1=[];
            businesses.forEach((business, index) => {
                // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ù…Ù‚Ø¯Ø§Ø± Ø§ÙˆÙ„ÛŒÙ‡
                console.log(business);
                business.transactions.sort((a, b) => {
                    const dateA = parseDate(a.date);
                    const dateB = parseDate(b.date);
                    return dateA - dateB; // Ø§Ú¯Ø± ØªØ§Ø±ÛŒØ® a Ú©ÙˆÚ†Ú©ØªØ± Ø§Ø² b Ø¨Ø§Ø´Ø¯ØŒ ØªØ±ØªÛŒØ¨ ØµØ¹ÙˆØ¯ÛŒ Ø®ÙˆØ§Ù‡Ø¯ Ø¨ÙˆØ¯
                });
                const initialDate = new persianDate().format('YYYY/MM/DD');
                const div = document.createElement('div');
                //const totalAmount = business.transactions.reduce((sum, transaction) => sum + transaction.amount, business.cash);
                let bb=business.cash;
                const now = new Date();
                const totalAmount = business.transactions.reduce((sum, transaction) => {
                  const transactionDate = new Date(transaction.date);
                  if (transactionDate <= now) {
                    return sum + transaction.amount;
                  }
                  return sum;
                }, business.cash);
                div.classList.add('business');
                div.innerHTML = `
                    <h3>${business.name}</h3>
                    <p>Ø³Ø±Ù…Ø§ÛŒÙ‡ Ø§ÙˆÙ„ÛŒÙ‡: ${formatNumber(business.cash)} ${business.currencyunit}</p>
                    <p>Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ù„Ø­Ø¸Ù‡ Ø§ÛŒ: ${formatNumber(totalAmount)} ${business.currencyunit}</p>
                    <div class="transaction-controls">
                        <input type="text" class="input-number" id="transaction-amount-${index}" placeholder="Ù…Ù‚Ø¯Ø§Ø±" oninput="formatInput(this)" />
                        <input type="text" id="transaction-description-${index}" placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª" />
                        <!-- ØªØºÛŒÛŒØ± Ù†ÙˆØ¹ input Ø¨Ù‡ text -->
                        <input type="text" id="transaction-date-${index}" placeholder="Ø§Ù†ØªØ®Ø§Ø¨ ØªØ§Ø±ÛŒØ®" value="${initialDate}" />
                        <button style="background: green;" onclick="addTransaction(${index}, 'profit')">Ø§ÙØ²ÙˆØ¯Ù† Ø³ÙˆØ¯</button>
                        <button style="background: red;" onclick="addTransaction(${index}, 'loss')">Ø§ÙØ²ÙˆØ¯Ù† Ø¶Ø±Ø±</button>
                    </div>
                    <button class="delete-btn" style="background:darkorange" onclick="deleteBusiness(${index})">Ø­Ø°Ù Ú©Ø³Ø¨â€ŒÙˆÚ©Ø§Ø±</button>
                    <h4>ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§:</h4>
                    <div class="transactions-list">
    ${business.transactions.map(t => {
        // ØªØ¨Ø¯ÛŒÙ„ ØªØ§Ø±ÛŒØ® ØªØ±Ø§Ú©Ù†Ø´ Ø¨Ù‡ Ø´ÛŒØ¡ Date
        const transactionDate = new Date(t.date);
        // Ù…Ù‚Ø§ÛŒØ³Ù‡ ØªØ§Ø±ÛŒØ® ØªØ±Ø§Ú©Ù†Ø´ Ø¨Ø§ ØªØ§Ø±ÛŒØ® Ø¬Ø§Ø±ÛŒ
        const isFuture = transactionDate > new Date();
        //let bbbb=t.balance
        bb += t.amount
        return `
            <div class="log" 
                 data-index="${business.transactions.indexOf(t)}" 
                 data-balance="${t.balance}" 
                 data-date="${t.date}" 
                 onclick="showCalculatedValue(${t.amount}, '${t.date}')"
                 style="background-color: ${isFuture ? 'yellow' : 'transparent'}">
                ${transactionDate.toLocaleDateString('fa-IR')} - ${t.type === 'profit' ? 'Ø³ÙˆØ¯' : 'Ø¶Ø±Ø±'}: ${formatNumber(t.amount)} ${business.currencyunit}
                | Ù…ÙˆØ¬ÙˆØ¯ÛŒ: ${formatNumber(bb)} ${business.currencyunit}
                | Ø¯Ø± Ø§Ø²Ø§ÛŒ: ${t.description}
                <button style="background:darkblue" onclick="event.stopPropagation(); deleteTransaction(${index}, this)">Ø­Ø°Ù ØªØ±Ø§Ú©Ù†Ø´</button>
            </div>
            <spam id="spammm${index}">
        `;
    }).join('')}
                    </div>     
                `;
                list.appendChild(div);
        
                // ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Persian Datepicker Ø±ÙˆÛŒ input ØªØ§Ø±ÛŒØ® Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ú©Ø³Ø¨â€ŒÙˆÚ©Ø§Ø±
                $(`#transaction-date-${index}`).persianDatepicker({
                    format: 'YYYY/MM/DD',
                    initialValue: true,
                    autoClose: true
                });
    let events = business.transactions;
// ØªØ¨Ø¯ÛŒÙ„ ØªØ§Ø±ÛŒØ® Ù…ÛŒÙ„Ø§Ø¯ÛŒ Ø¨Ù‡ ØªØ§Ø±ÛŒØ® Ø¬Ù„Ø§Ù„ÛŒ
const convertToJalaali = (dateString) => {
  const dateObj = new Date(dateString);
  const jalaaliDate = jalaali.toJalaali(dateObj.getFullYear(), dateObj.getMonth() + 1, dateObj.getDate());
  return `${jalaaliDate.jy}/${jalaaliDate.jm < 10 ? "0" + jalaaliDate.jm : jalaaliDate.jm}/${jalaaliDate.jd < 10 ? "0" + jalaaliDate.jd : jalaaliDate.jd}`;
};

// ØªØ¨Ø¯ÛŒÙ„ ØªÙ…Ø§Ù…ÛŒ ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§
events = events.map(event => {
  return {
    description: event.description,
    date: convertToJalaali(event.date)
  };
});
const markedDates = events.map(event => event.date.split(",")[0]); // Ø­Ø°Ù Ø³Ø§Ø¹Øª Ø§Ø² ØªØ§Ø±ÛŒØ®
const des = events.map(event => event.description);
console.log("**************************************",currentYear, currentMonth,markedDates,des);
        dates.push(...markedDates);
        dess.push(...des);
    // ØªÙˆÙ„ÛŒØ¯ ØªÙ‚ÙˆÛŒÙ… Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØµÙØ­Ù‡
      //generateCalendar(currentYear, currentMonth,markedDates,des);
            });
        }
        function deleteTransaction(businessIndex, buttonElement) {
            // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø§Ù„Ù…Ø§Ù† ÙˆØ§Ù„Ø¯ Ú©Ù‡ Ø­Ø§ÙˆÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªØ±Ø§Ú©Ù†Ø´ Ø§Ø³Øª
            const transactionDiv = buttonElement.closest('.log');
            // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù†Ø¯ÛŒØ³ ØªØ±Ø§Ú©Ù†Ø´ Ø§Ø² ÙˆÛŒÚ˜Ú¯ÛŒ Ø¯Ø§Ø¯Ù‡ data-index
            const transactionIndex = parseInt(transactionDiv.getAttribute('data-index'));
            // Ø­Ø°Ù ØªØ±Ø§Ú©Ù†Ø´ Ø§Ø² Ø¢Ø±Ø§ÛŒÙ‡
            businesses[businessIndex].transactions.splice(transactionIndex, 1);
            // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù†Ù…Ø§ÛŒØ´ Ú©Ø³Ø¨â€ŒÙˆÚ©Ø§Ø±Ù‡Ø§
            saveData();
            renderBusinesses();
        }
        function scrollToBusiness(index) {
            const chartElement = document.getElementById(`spammm${index}`);
            chartElement.scrollIntoView({ behavior: 'smooth' });
        }
    const todayGregorian = new Date();
    const todayJ = jalaali.toJalaali(
      todayGregorian.getFullYear(),
      todayGregorian.getMonth() + 1,
      todayGregorian.getDate()
    );
    // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ù…Ø§Ù‡ Ùˆ Ø³Ø§Ù„ Ø¬Ø§Ø±ÛŒ Ø´Ù…Ø³ÛŒ
    let currentYear = todayJ.jy;
    let currentMonth = todayJ.jm; // Ù…Ø§Ù‡ Ø§Ø² 1 ØªØ§ 12

    // ØªØ§Ø¨Ø¹ Ø³Ø§Ø®Øª ØªÙ‚ÙˆÛŒÙ… Ø¨Ø±Ø§ÛŒ Ù…Ø§Ù‡ Ùˆ Ø³Ø§Ù„ Ù…Ø´Ø®Øµ
    function generateCalendar(year, month,data,des) {
      // ØªØ¹ÛŒÛŒÙ† ØªØ¹Ø¯Ø§Ø¯ Ø±ÙˆØ²Ù‡Ø§ÛŒ Ù…Ø§Ù‡ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…Ø§Ù‡ Ø´Ù…Ø³ÛŒ
      let daysInMonth;
      if (month <= 6) {
        daysInMonth = 31;
      } else if (month <= 11) {
        daysInMonth = 30;
      } else {
        daysInMonth = jalaali.isLeapJalaaliYear(year) ? 30 : 29;
      }
      
      // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø±ÙˆØ² Ù‡ÙØªÙ‡ Ø§ÙˆÙ„ÛŒÙ† Ø±ÙˆØ² Ù…Ø§Ù‡
      const gDate = jalaali.toGregorian(year, month, 1);
      const firstDayDate = new Date(gDate.gy, gDate.gm - 1, gDate.gd);
      let jsDay = firstDayDate.getDay(); // 0 (ÛŒÚ©Ø´Ù†Ø¨Ù‡) ØªØ§ 6 (Ø´Ù†Ø¨Ù‡)
      // ØªÙ†Ø¸ÛŒÙ… Ø´Ø±ÙˆØ¹ Ù‡ÙØªÙ‡Ø› Ø¯Ø± ØªÙ‚ÙˆÛŒÙ… ÙØ§Ø±Ø³ÛŒ Ø´Ù†Ø¨Ù‡ Ø§ÙˆÙ„ÛŒÙ† Ø±ÙˆØ² Ù‡ÙØªÙ‡ Ø§Ø³Øª:
      let startIndex = (jsDay + 1) % 7;
      
      // Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ ØªÙ‚ÙˆÛŒÙ… Ù‚Ø¯ÛŒÙ…ÛŒ
      const calendarBody = document.getElementById("calendarBody");
      calendarBody.innerHTML = "";

      // Ù†Ù…Ø§ÛŒØ´ Ø¹Ù†ÙˆØ§Ù† Ù…Ø§Ù‡ Ùˆ Ø³Ø§Ù„
      document.getElementById("monthYear").innerText =
        year + "/" + (month < 10 ? "0" + month : month);

      let row = document.createElement("tr");
      // Ø§ÛŒØ¬Ø§Ø¯ Ø³Ù„ÙˆÙ„â€ŒÙ‡Ø§ÛŒ Ø®Ø§Ù„ÛŒ Ø¨Ø±Ø§ÛŒ Ø±ÙˆØ²Ù‡Ø§ÛŒÛŒ Ú©Ù‡ Ù‚Ø¨Ù„ Ø§Ø² Ø§ÙˆÙ„ÛŒÙ† Ø±ÙˆØ² Ù…Ø§Ù‡ Ù‡Ø³ØªÙ†Ø¯
      for (let i = 0; i < startIndex; i++) {
        let cell = document.createElement("td");
        cell.innerText = "";
        row.appendChild(cell);
      }
      // Ù¾Ø± Ú©Ø±Ø¯Ù† Ø³Ù„ÙˆÙ„â€ŒÙ‡Ø§ÛŒ Ø±ÙˆØ²Ù‡Ø§ÛŒ Ù…Ø§Ù‡
      for (let day = 1; day <= daysInMonth; day++) {
        if (row.children.length === 7) {
          calendarBody.appendChild(row);
          row = document.createElement("tr");
        }
        let cell = document.createElement("td");
        cell.innerText = day;
        // ÙØ±Ù…Øªâ€ŒØ¯Ù‡ÛŒ ØªØ§Ø±ÛŒØ® Ø¨Ù‡ ØµÙˆØ±Øª "YYYY/MM/DD"
        let dayString = day < 10 ? "0" + day : day;
        let monthString = month < 10 ? "0" + month : month;
        let dateStr = year + "/" + monthString + "/" + dayString;

        // Ø§Ú¯Ø± ØªØ§Ø±ÛŒØ® Ø¯Ø± Ø¢Ø±Ø§ÛŒÙ‡ markedDates ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯ØŒ Ù‡Ø§ÛŒÙ„Ø§ÛŒØª Ùˆ Ú©Ù„ÛŒÚ© Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯
        if (data.includes(dateStr)) {
          let index = data.indexOf(dateStr);
          //cell.classList.add("marked");
          let status = checkFutureDate(dateStr);
          if (status){
            showNotification("ØµÙˆØ±Øª Ø­Ø³Ø§Ø¨ Ù‡Ø§ÛŒ Ø¢ÛŒÙ†Ø¯Ù‡ :" + dateStr + "\n" + des[index]);
            cell.classList.add("mark"); 
          }
          else{
            cell.classList.add("marked"); 
          }
          cell.onclick = function() {
            openModal("Ø±ÙˆÛŒØ¯Ø§Ø¯ ÙˆÛŒÚ˜Ù‡ Ø¨Ø±Ø§ÛŒ ØªØ§Ø±ÛŒØ® " + dateStr + "\n" + des[index]);
          }
        }

        // Ù…Ø´Ø®Øµ Ú©Ø±Ø¯Ù† Ø§Ù…Ø±ÙˆØ² (Ø§Ú¯Ø± ØªØ§Ø±ÛŒØ® Ø¨Ø§ ØªØ§Ø±ÛŒØ® Ø§Ù…Ø±ÙˆØ² Ù…Ø·Ø§Ø¨Ù‚Øª Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯)
        if (year === todayJ.jy && month === todayJ.jm && day === todayJ.jd) {
          cell.classList.add("today");
        }

        row.appendChild(cell);
      }
      // Ù¾Ø± Ú©Ø±Ø¯Ù† Ø³Ù„ÙˆÙ„â€ŒÙ‡Ø§ÛŒ Ø®Ø§Ù„ÛŒ Ø§Ù†ØªÙ‡Ø§ÛŒ Ø±Ø¯ÛŒÙ (Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø²)
      while (row.children.length < 7) {
        let cell = document.createElement("td");
        cell.innerText = "";
        row.appendChild(cell);
      }
      calendarBody.appendChild(row);

    }

    // Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ù†Ø§ÙˆØ¨Ø±ÛŒ:
    function previousMonth() {
      currentMonth--;
      if (currentMonth < 1) {
        currentMonth = 12;
        currentYear--;
      }
      generateCalendar(currentYear, currentMonth,dates,dess);  
      renderBusinesses();
    }
    function nextMonth() {
      currentMonth++;
      if (currentMonth > 12) {
        currentMonth = 1;
          currentYear++;
      }
      generateCalendar(currentYear, currentMonth,dates,dess);  
      renderBusinesses();
    }
    function previousYear() {
      currentYear--;
      generateCalendar(currentYear, currentMonth,dates,dess);  
      renderBusinesses();
    }
    function nextYear() {
      currentYear++;
      generateCalendar(currentYear, currentMonth,dates,dess);  
      renderBusinesses();
    }

    // ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ø¢Ø±Ø§ÛŒÙ‡ ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§ Ùˆ Ù‡Ø§ÛŒÙ„Ø§ÛŒØª Ø¢Ù†â€ŒÙ‡Ø§


    // ØªÙˆØ§Ø¨Ø¹ Ù†Ù…Ø§ÛŒØ´ Ùˆ Ø¨Ø³ØªÙ† modal
    function openModal(content) {
      document.getElementById("modalContent").innerText = content;
      document.getElementById("modalOverlay").style.display = "block";
      document.getElementById("modal").style.display = "block";
    }
    function closeModal() {
      document.getElementById("modalOverlay").style.display = "none";
      document.getElementById("modal").style.display = "none";
    }
    function checkFutureDate(jalaliDateStr) {
      // ØªØ¨Ø¯ÛŒÙ„ Ø±Ø´ØªÙ‡ ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ Ø¨Ù‡ Ø´ÛŒØ¡ moment Ø¨Ø§ ÙØ±Ù…Øª Ø¬Ù„Ø§Ù„ÛŒ
      var date = moment(jalaliDateStr, 'jYYYY/jMM/jDD');
      
      // Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ ØªØ§Ø±ÛŒØ® ÙˆØ±ÙˆØ¯ÛŒ
      if (!date.isValid()) {
        console.log("ØªØ§Ø±ÛŒØ® ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª.");
        return;
      }
      
      // Ù…Ù‚Ø§ÛŒØ³Ù‡ ØªØ§Ø±ÛŒØ® ØªØ¨Ø¯ÛŒÙ„â€ŒØ´Ø¯Ù‡ Ø¨Ø§ ØªØ§Ø±ÛŒØ® ÙØ¹Ù„ÛŒ
      if (date.isAfter(moment())) {
        console.log("ØªØ§Ø±ÛŒØ® Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡ Ø¯Ø± Ø¢ÛŒÙ†Ø¯Ù‡ Ø§Ø³Øª.");
        return true;
      } else {
        console.log("ØªØ§Ø±ÛŒØ® Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡ Ø¯Ø± Ø¢ÛŒÙ†Ø¯Ù‡ Ù†ÛŒØ³Øª.");
        return false;
      }
    }
    function showNotification(message = 'ğŸ”” ÛŒÚ© Ø§Ø¹Ù„Ø§Ù† Ø¬Ø¯ÛŒØ¯ Ø¯Ø§Ø±ÛŒØ¯!') {
      // Ø¨Ø±Ø±Ø³ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù…Ø±ÙˆØ±Ú¯Ø± Ø§Ø² Notification API
      if (!('Notification' in window)) {
        console.error('Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ Ø§Ø² Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒÚ©Ù†Ø¯!');
        return;
      }

      // Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø¬ÙˆØ²Ù‡Ø§ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ
      if (Notification.permission === 'granted') {
        // Ø§Ú¯Ø± Ù…Ø¬ÙˆØ² Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡ØŒ Ù…Ø³ØªÙ‚ÛŒÙ…Ø§Ù‹ Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ø±Ø§ Ù†Ø´Ø§Ù† Ø¨Ø¯Ù‡
        new Notification('Ø§Ø¹Ù„Ø§Ù† Ø¬Ø¯ÛŒØ¯ :', {
          body: message,
          icon: 'asset/notification-icon.png' // Ø¢Ø¯Ø±Ø³ Ø¢ÛŒÚ©ÙˆÙ† Ø§Ø®ØªÛŒØ§Ø±ÛŒ
        });
      } else if (Notification.permission !== 'denied') {
        // Ø§Ú¯Ø± Ù…Ø¬ÙˆØ² Ø±Ø¯ Ù†Ø´Ø¯Ù‡ØŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù…Ø¬ÙˆØ² Ú©Ù†ÛŒÙ…
        Notification.requestPermission().then(permission => {
          if (permission === 'granted') {
            new Notification('Ø§Ø¹Ù„Ø§Ù† Ø³ÛŒØ³ØªÙ…', {
              body: message,
              icon: '/notification-icon.png'
            });
          }
        });
      }
}
        function getMonthDifference(date1, date2) {
            const d1 = new Date(date1);
            const d2 = new Date(date2);

            let yearDiff = d2.getFullYear() - d1.getFullYear();
            let monthDiff = d2.getMonth() - d1.getMonth();

            return yearDiff * 12 + monthDiff;
        }
        function getDayDifference(date1, date2) {
            const d1 = new Date(date1);
            const d2 = new Date(date2);
            const diffMs = d2 - d1; // Ø§Ø®ØªÙ„Ø§Ù Ø¨Ø±Ø­Ø³Ø¨ Ù…ÛŒÙ„ÛŒâ€ŒØ«Ø§Ù†ÛŒÙ‡
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24)); // ØªØ¨Ø¯ÛŒÙ„ Ù…ÛŒÙ„ÛŒâ€ŒØ«Ø§Ù†ÛŒÙ‡ Ø¨Ù‡ Ø±ÙˆØ²
            return diffDays;
        }
        //  DoneÙ¾Ø±ÙˆÚ˜Ù‡ ÙØ±Ø¯Ø§ Ø´Ø¨

        function calculateValue(balance, transactionDate) {
            const rate = 22.5;
            const monthsInYear = 365;
        
            // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ù‚Ø¯Ø§Ø± Ø§ÙˆÙ„ÛŒÙ‡
            let result = (balance * rate) / monthsInYear;
            console.log("------------------",transactionDate);
            let transactionTime = new Date(transactionDate);
            // ØªØ¨Ø¯ÛŒÙ„ ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ Ø¨Ù‡ Ù…ÛŒÙ„Ø§Ø¯ÛŒ
            //let transactionTime = convertShamsiToMiladi(transactionDate);
            let now = new Date(); // ØªØ§Ø±ÛŒØ® Ø§Ù…Ø±ÙˆØ² Ù…ÛŒÙ„Ø§Ø¯ÛŒ
        
            // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø§Ø®ØªÙ„Ø§Ù Ù…Ø§Ù‡ÛŒØ§Ù†Ù‡
            let yearDiff = now.getFullYear() - transactionTime.getFullYear();
            let monthDiff = now.getMonth() - transactionTime.getMonth();
            let totalMonths = getDayDifference(transactionTime,now);
        
        
            console.log("Ø§Ø®ØªÙ„Ø§Ù Ù…Ø§Ù‡ÛŒØ§Ù†Ù‡:", totalMonths); // Ø¨Ø§ÛŒØ¯ Ø¹Ø¯Ø¯ ØµØ­ÛŒØ­ Ø¨Ø§Ø´Ù‡
            console.log("Ù…Ù‚Ø¯Ø§Ø± Ø§ÙˆÙ„ÛŒÙ‡:", result);
        
            // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ù‚Ø¯Ø§Ø± Ù†Ù‡Ø§ÛŒÛŒ
            let finalValue = Math.round(result * totalMonths/100);
            
            return isNaN(finalValue) ? "Ø®Ø·Ø§ Ø¯Ø± Ù…Ø­Ø§Ø³Ø¨Ù‡!" : finalValue;
        }
        
        function showCalculatedValue(balance, transactionDate) {
            let value = calculateValue(balance, transactionDate);
            alert(`Ù…Ù‚Ø¯Ø§Ø± Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø´Ø¯Ù‡: ${value} ØªÙˆÙ…Ø§Ù†`);
        }
        // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ú©Ù„ÛŒÚ© Ø¨Ù‡ Ù„Ø§Ú¯â€ŒÙ‡Ø§
        document.addEventListener('DOMContentLoaded', function() {
            let executed = false;
            document.querySelectorAll('.log').forEach(log => {
                         if (executed) return; // Ø§Ú¯Ø± Ù‚Ø¨Ù„Ø§Ù‹ Ø§Ø¬Ø±Ø§ Ø´Ø¯Ù‡ Ø¨ÙˆØ¯ØŒ Ø®Ø±ÙˆØ¬ Ø§Ø² ØªØ§Ø¨Ø¹
                              executed = true; // Ø¹Ù„Ø§Ù…Øª Ù…ÛŒâ€ŒØ²Ù†ÛŒÙ… Ú©Ù‡ ØªØ§Ø¨Ø¹ Ø§Ø¬Ø±Ø§ Ø´Ø¯Ù‡ Ø§Ø³Øª
                              let balance = parseFloat(this.getAttribute('data-balance'));
                              let date = this.getAttribute('data-date');
                              showCalculatedValue(balance, date);                      
            });
        });
        renderBusinesses();
        console.log("88888888888888888888888",dates,dess,"999999999999999999");
        generateCalendar(currentYear, currentMonth,dates,dess); 
    </script>
</body>
</html>
