<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/persian-datepicker/dist/css/persian-datepicker.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/persian-date@latest/dist/persian-date.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/js/persian-datepicker.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/css/persian-datepicker.min.css">
    <script src="https://unpkg.com/jalaali-js/dist/jalaali.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment-jalaali@0.9.2/build/moment-jalaali.js"></script>
    <title>نرم‌افزار حسابداری</title>
    <style>







:root {
    --background: #f2eee3;
    --check: #000;
    --ball: #f2eee3;
}

.dark {
    --background: #000;
    --check: #f2eee3;
    --ball: #000;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

.dark-mode {
    display: grid;
    width: 100%;
    justify-items: center;
    align-items: center;
    background: var(--background);
    transition: .5s;
}

.checkbox:checked+.label .ball {
    transform: translateX(24px);
}

.checkbox {
    opacity: 0;
    position: absolute;
}

.label {
    width: 50px;
    height: 26px;
    background: var(--check);
    border-radius: 50px;
    padding: 5px;
    position: relative;
}

.ball {
    position: absolute;
    top: 2px;
    left: 2px;
    width: 22px;
    height: 22px;
    background: var(--ball);
    border-radius: 50%;
    transition: transform 0.2s linear;
}
















    /* تعریف متغیرهای اصلی برای تم روشن */
    :root {
      direction: rtl;
      writing-mode: horizontal-tb;
      text-orientation: mixed;

      --primary-bg: #ffffff;
      --primary-text: #333;
      --container-bg: #fff;
      --input-bg: #f8f8f8;
      --input-border: #ddd;
      --button-bg: linear-gradient(135deg, #007bff, #0056b3);
      --button-hover-bg: linear-gradient(135deg, #0056b3, #003f7f);
    }

    /* استایل‌های کلی صفحه */
    body {
      display: grid;
      font-family: 'Tajawal', Arial, sans-serif;
      text-align: right;
      background: linear-gradient(135deg, #ece9e6, var(--primary-bg));
      margin: 0;
      padding: 0;
      color: var(--primary-text);
    }
    .container {
      width: 90%;
      max-width: 600px;
      margin: 0px auto;
      background: var(--container-bg);
      padding: 25px;
      border-radius: 50px;
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
    }
    h2 {
      text-align: center;
      font-size: 26px;
      color: var(--primary-text);
      margin-bottom: 20px;
      font-weight: bold;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
    }

    /* استایل ورودی‌ها */
    input[type="text"], input[type="number"] {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      border: 2px solid var(--input-border);
      border-radius: 8px;
      box-sizing: border-box;
      margin-bottom: 12px;
      transition: 0.3s ease;
      background: var(--input-bg);
      color: var(--primary-text);
    }
    input[type="text"]:focus, input[type="number"]:focus {
      border-color: #007bff;
      box-shadow: 0 0 8px rgba(0, 123, 255, 0.5);
      background: var(--primary-bg);
    }
    input::placeholder {
      color: #888;
      font-style: italic;
    }

    /* استایل دکمه‌ها */
    button {
      background: var(--button-bg);
      color: white;
      padding: 14px;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      width: 100%;
      transition: 0.3s;
      font-weight: bold;
    }
    button:hover {
      background: var(--button-hover-bg);
    }

    /* استایل دکمه حذف */
    .delete-btn {
      background: linear-gradient(135deg, #dc3545, #b21f2d);
      color: white;
      border: none;
      padding: 6px 12px;
      cursor: pointer;
      border-radius: 5px;
      transition: 0.3s;
      font-weight: bold;
    }
    .delete-btn:hover {
      background: linear-gradient(135deg, #b21f2d, #8b1522);
    }

    /* استایل نمایش لیست کسب‌وکار */
    .business {
      border: 1px solid #ddd;
      padding: 18px;
      margin-top: 12px;
      background: var(--container-bg);
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease;
    }
    .business:hover {
      transform: scale(1.03);
    }

    /* استایل متن تراکنش‌ها */
    .log {
      background: #f9f9f9;
      padding: 10px;
      margin-top: 6px;
      border-radius: 6px;
      font-size: 15px;
      font-weight: bold;
      border-left: 4px solid #007bff;
    }

    /* استایل‌های مربوط به تقویم */
    #calendarContainer {
      width: 90%;
      margin: 50px auto;
      text-align: center;
    }
    #monthYear {
      margin-bottom: 10px;
      font-size: 1.2em;
      font-weight: bold;
    }
    #calendar {
      width: 100%;
      border-collapse: collapse;
    }
    #calendar th, #calendar td {
      border: 1px solid #ccc;
      padding: 8px;
      height: 40px;
      vertical-align: middle;
    }
    #calendar th {
      background: #f2f2f2;
    }
    .marked {
      background: #4CAF50;
      cursor: pointer;
    }
    .mark {
      background: #F44336;
      cursor: pointer;
    }
    .today {
      border: 2px solid red;
    }
    /* استایل modal */
    #modalOverlay {
      display: none;
      position: fixed;
      top:0;
      left:0;
      width:100%;
      height:100%;
      background: rgba(0,0,0,0.5);
      z-index: 100;
    }
    #modal {
      display: none;
      position: fixed;
      top: 50%;
      left:50%;
      transform: translate(-50%, -50%);
      background: var(--container-bg);
      padding: 20px;
      z-index: 101;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
    }
    #modal button {
      margin-top: 10px;
    }
    .nav-buttons {
      margin: 10px 0;
    }
    .nav-buttons button {
      margin: 0 5px;
      padding: 5px 10px;
    }

    /* تغییرات استایل برای حالت Dark Mode */
    body.dark-mode {
      --primary-bg: #1a1a1a;
      --primary-text: #f0f0f0;
      --container-bg: #2c2c2c;
      --input-bg: #3a3a3a;
      --input-border: #555;
      background: linear-gradient(135deg, #2c2c2c, #1a1a1a);
    }
    body.dark-mode .business,
    body.dark-mode .container,
    body.dark-mode #modal {
      background: var(--container-bg);
      box-shadow: 0 10px 20px rgba(0,0,0,0.5);
    }
    body.dark-mode input[type="text"],
    body.dark-mode input[type="number"] {
      background: var(--input-bg);
      border: 2px solid var(--input-border);
      color: var(--primary-text);
    }
    body.dark-mode input::placeholder {
      color: #ccc;
    }
    body.dark-mode .log {
      background: #333;
      border-left: 4px solid #007bff;
      color: var(--primary-text);
    }
    body.dark-mode #calendar th,
    body.dark-mode #calendar td {
      border: 1px solid #555;
    }
    body.dark-mode #calendar th {
      background: #444;
    }
    </style>
</head>
<body>


    <div class="dark-mode container">
        <input type="checkbox" class='checkbox' id='checkbox' placeholder='checkbox'>
        <label for="checkbox" class='label'>
            <div class="ball"> </div>
        </label>
    </div>

<!--
   <div class="container">
    <h2>صفحه تست حالت Dark/Normal</h2>
    <button id="toggleMode">تغییر به حالت تیره</button>

    <p>این یک متن نمونه برای تست تغییر تم است.</p>
  </div>
  -->

  <div id="calendarContainer" class="container">
    <!-- دکمه‌های ناوبری برای تغییر ماه و سال -->
    <div class="nav-buttons">
      <button onclick="previousYear()">سال قبل</button>
      <button onclick="previousMonth()">ماه قبل</button>
      <button onclick="nextMonth()">ماه بعد</button>
      <button onclick="nextYear()">سال بعد</button>
    </div>
    <h2 id="monthYear"></h2>
    <table id="calendar">
      <thead>
        <tr>
          <th>ش</th> <!-- شنبه -->
          <th>ی</th> <!-- یکشنبه -->
          <th>د</th> <!-- دوشنبه -->
          <th>س</th> <!-- سه‌شنبه -->
          <th>چ</th> <!-- چهارشنبه -->
          <th>پ</th> <!-- پنجشنبه -->
          <th>ج</th> <!-- جمعه -->
        </tr>
      </thead>
      <tbody id="calendarBody">
      </tbody>
    </table>
  </div>
    <div class="container" id="add-businesses">
        <h2>مدیریت کسب‌وکارها</h2>
        <input type="text" id="businessName" placeholder="نام کسب‌وکار">
        <input type="text" id="initialCash" class="input-number" placeholder="سرمایه اولیه " oninput="formatInput(this)">
        <input type="text" id="currencyunit" placeholder="واحد پول کسب و کار را وارد کنید">
        <button onclick="addBusiness()">افزودن کسب‌وکار</button>
    </div>

        <div class="container"id="businessList"></div>
  <!-- overlay و modal برای نمایش اطلاعات -->
  <div id="modalOverlay"></div>
  <div id="modal">
    <p id="modalContent"></p>
    <button onclick="closeModal()">بستن</button>
  </div>


  
    <script>


    // تابع ذخیره کردن کوکی
    function setCookie(name, value, days) {
      let expires = "";
      if (days) {
        const date = new Date();
        date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
        expires = "; expires=" + date.toUTCString();
      }
      document.cookie = name + "=" + (value || "") + expires + "; path=/";
    }

    // تابع دریافت مقدار کوکی
    function getCookie(name) {
      const nameEQ = name + "=";
      const ca = document.cookie.split(';');
      for (let i = 0; i < ca.length; i++) {
        let c = ca[i];
        while (c.charAt(0) === ' ') c = c.substring(1);
        if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
      }
      return null;
    }

    // انتخاب دکمه تغییر تم
    const toggleButton = document.getElementById('checkbox');

    // بررسی کوکی در بارگذاری صفحه
    const savedTheme = getCookie("theme");
    if (savedTheme === "dark") {
      document.body.classList.add("dark-mode");
      toggleButton.addEventListener('change', function() {
    html.classList.toggle('dark')
})
    } else {
      toggleButton.addEventListener('change', function() {
    html.classList.toggle('dark')
})
    }

    // تغییر تم و ذخیره در کوکی هنگام کلیک دکمه
    toggleButton.addEventListener('click', () => {
      document.body.classList.toggle('dark-mode');
      if (document.body.classList.contains('dark-mode')) {
        toggleButton.textContent = addEventListener('change', function() {
    html.classList.toggle('dark')
})
        setCookie("theme", "dark", 7); // ذخیره برای 7 روز
      } else {
        toggleButton.textContent = addEventListener('change', function() {
    html.classList.toggle('dark')
})
        setCookie("theme", "light", 7);
      }
    });


        let dates=[];
        let dess=[];
        ////////////////////////////////////////////
        let businesses = JSON.parse(localStorage.getItem('businesses')) || [];
        console.log(businesses);
        const parseDate = (dateString) => {
            return new Date(dateString);
        };       


    if (businesses.length > 0) {
      // انتخاب div مورد نظر با شناسه "targetDiv"
      const targetDiv = document.getElementById("add-businesses");
      // اگر div پیدا شد، آن را از صفحه حذف کن
      if (targetDiv) {
        targetDiv.remove();
      }
    }





        ///////////////////////////*************************************************************///////////////////////
        function saveData() {
            localStorage.setItem('businesses', JSON.stringify(businesses));
        }
        function formatInput(input) {
            // جدا کردن بخش صحیح و اعشاری
            let parts = input.value.split('.');
            let integerPart = parts[0]; // بخش صحیح
            let decimalPart = parts.length > 1 ? '.' + parts[1] : ''; // بخش اعشاری (اگر وجود داشت)

            // حذف کاراکترهای غیر عددی از بخش صحیح
            integerPart = integerPart.replace(/[^\d]/g, '');

            // افزودن ویرگول به بخش صحیح
            integerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ',');

            // ترکیب بخش صحیح و اعشاری
            input.value = integerPart + decimalPart;
        }
        function addBusiness() {
            const name = document.getElementById('businessName').value;
            const cash = parseFloat(document.getElementById('initialCash').value.replace(/,/g, '')); // حذف ویرگول‌ها برای تبدیل به عدد
            const currencyunit = document.getElementById('currencyunit').value;
            if (name && !isNaN(cash)) {
                businesses.push({ name, cash, currencyunit,transactions: [] });
                saveData();
                //renderBusinesses();
                document.getElementById('businessName').value = '';
                document.getElementById('initialCash').value = '';
            }
            location.reload();
        }
        function convertJalaliToGregorian(jalaliDate) {
            return moment(jalaliDate, 'jYYYY/jM/jD').format('YYYY-MM-DD');
        }
        function convertPersianToEnglish(str) {
            return str.replace(/[۰-۹]/g, d => "0123456789"["۰۱۲۳۴۵۶۷۸۹".indexOf(d)]);
        }
        function addTransaction(index, type) {
            // دریافت مقادیر ورودی از فیلدهای مربوط به کسب‌وکار با اندیس index
            const amountInput = document.getElementById(`transaction-amount-${index}`);
            const descriptionInput = document.getElementById(`transaction-description-${index}`);
            const dateInput = document.getElementById(`transaction-date-${index}`);
        
            let  amount = parseFloat(amountInput.value.replace(/,/g, ''));
            const description = descriptionInput.value.trim();
            // اگر فیلد زمان مقدار داشته باشد، از آن استفاده می‌کنیم، در غیر این صورت زمان فعلی را می‌گیریم
            console.log("*****",dateInput.value);
            console.log("#####",convertPersianToEnglish(dateInput.value));
            console.log("XXXXX",convertJalaliToGregorian(convertPersianToEnglish(dateInput.value)));
            const date = dateInput.value ? new Date(convertJalaliToGregorian(convertPersianToEnglish(dateInput.value))) : new Date();
        
            if (!isNaN(amount) && amount > 0 && description) {
                //businesses[index].cash += type === 'profit' ? amount : -amount;
                amount = type === 'profit' ? amount : -amount;
                businesses[index].transactions.push({ 
                    type, 
                    amount, 
                    description, 
                    date: date.toLocaleString('en-US'), 
                    balance: businesses[index].cash 
                });
                saveData();
                renderBusinesses();
                scrollToBusiness(index);
            } else {
                alert("لطفاً مقدار و توضیحات معتبر وارد کنید");
            }
        }
        
        function deleteBusiness(index) {
            if (confirm("آیا مطمئن هستید که می‌خواهید این کسب‌وکار را حذف کنید؟")) {
                businesses.splice(index, 1);
                saveData();
                //renderBusinesses();
            }
            location.reload();
        }
        function formatNumber(number) {
            // ابتدا اطمینان حاصل می‌کنیم که ورودی یک عدد است
            if (isNaN(number)) {
                console.error("The input is not a valid number");
                return;
            }
            let prefix = "";
            if (number < 0){
                prefix="-";
            }
            if (number > 0){
                prefix="+";
            }
            let text = number.toString(); // تبدیل عدد به رشته
            let parts = text.split('.');
            let integerPart = parts[0];
            let decimalPart = parts.length > 1 ? '.' + parts[1] : '';

            // حذف همه کاراکترهای غیر عددی
            integerPart = integerPart.replace(/[^\d]/g, '');

            // جدا کردن هزارگان
            integerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ',');

            return prefix + integerPart + decimalPart;
        }
        function renderBusinesses() {


            if (businesses.length == 0) {
              // انتخاب div مورد نظر با شناسه "targetDiv"
              const targetDiv = document.getElementById("businessList");
              // اگر div پیدا شد، آن را از صفحه حذف کن
              if (targetDiv) {
                targetDiv.remove();
              }
              return 0;
            }


            const list = document.getElementById('businessList');
            list.innerHTML = '';
            //let array1=[];
            businesses.forEach((business, index) => {
                // استفاده از تاریخ شمسی به عنوان مقدار اولیه
                console.log(business);
                business.transactions.sort((a, b) => {
                    const dateA = parseDate(a.date);
                    const dateB = parseDate(b.date);
                    return dateA - dateB; // اگر تاریخ a کوچکتر از b باشد، ترتیب صعودی خواهد بود
                });
                const initialDate = new persianDate().format('YYYY/MM/DD');
                const div = document.createElement('div');
                //const totalAmount = business.transactions.reduce((sum, transaction) => sum + transaction.amount, business.cash);
                let bb=business.cash;
                const now = new Date();
                const totalAmount = business.transactions.reduce((sum, transaction) => {
                  const transactionDate = new Date(transaction.date);
                  if (transactionDate <= now) {
                    return sum + transaction.amount;
                  }
                  return sum;
                }, business.cash);
                div.classList.add('business');
                div.innerHTML = `
                    <h3>${business.name}</h3>
                    <p>سرمایه اولیه: ${formatNumber(business.cash)} ${business.currencyunit}</p>
                    <p>موجودی لحظه ای: ${formatNumber(totalAmount)} ${business.currencyunit}</p>
                    <div class="transaction-controls">
                        <input type="text" class="input-number" id="transaction-amount-${index}" placeholder="مقدار" oninput="formatInput(this)" />
                        <input type="text" id="transaction-description-${index}" placeholder="توضیحات" />
                        <!-- تغییر نوع input به text -->
                        <input type="text" id="transaction-date-${index}" placeholder="انتخاب تاریخ" value="${initialDate}" />
                        <button style="background: green;" onclick="addTransaction(${index}, 'profit')">افزودن سود</button>
                        <button style="background: red;" onclick="addTransaction(${index}, 'loss')">افزودن ضرر</button>
                    </div>
                    <button class="delete-btn" style="background:darkorange" onclick="deleteBusiness(${index})">حذف کسب‌وکار</button>
                    <h4>تراکنش‌ها:</h4>
                    <div class="transactions-list">
    ${business.transactions.map(t => {
        // تبدیل تاریخ تراکنش به شیء Date
        const transactionDate = new Date(t.date);
        // مقایسه تاریخ تراکنش با تاریخ جاری
        const isFuture = transactionDate > new Date();
        //let bbbb=t.balance
        bb += t.amount
        return `
            <div class="log" 
                 data-index="${business.transactions.indexOf(t)}" 
                 data-balance="${t.balance}" 
                 data-date="${t.date}" 
                 onclick="showCalculatedValue(${t.amount}, '${t.date}')"
                 style="background-color: ${isFuture ? 'yellow' : 'transparent'}">
                ${transactionDate.toLocaleDateString('fa-IR')} - ${t.type === 'profit' ? 'سود' : 'ضرر'}: ${formatNumber(t.amount)} ${business.currencyunit}
                | موجودی: ${formatNumber(bb)} ${business.currencyunit}
                | در ازای: ${t.description}
                <button style="background:darkblue" onclick="event.stopPropagation(); deleteTransaction(${index}, this)">حذف تراکنش</button>
            </div>
            <spam id="spammm${index}">
        `;
    }).join('')}
                    </div>     
                `;
                list.appendChild(div);
        
                // فعال‌سازی Persian Datepicker روی input تاریخ برای هر کسب‌وکار
                $(`#transaction-date-${index}`).persianDatepicker({
                    format: 'YYYY/MM/DD',
                    initialValue: true,
                    autoClose: true
                });
    let events = business.transactions;
// تبدیل تاریخ میلادی به تاریخ جلالی
const convertToJalaali = (dateString) => {
  const dateObj = new Date(dateString);
  const jalaaliDate = jalaali.toJalaali(dateObj.getFullYear(), dateObj.getMonth() + 1, dateObj.getDate());
  return `${jalaaliDate.jy}/${jalaaliDate.jm < 10 ? "0" + jalaaliDate.jm : jalaaliDate.jm}/${jalaaliDate.jd < 10 ? "0" + jalaaliDate.jd : jalaaliDate.jd}`;
};

// تبدیل تمامی تاریخ‌ها
events = events.map(event => {
  return {
    description: event.description,
    date: convertToJalaali(event.date)
  };
});
const markedDates = events.map(event => event.date.split(",")[0]); // حذف ساعت از تاریخ
const des = events.map(event => event.description);
console.log("**************************************",currentYear, currentMonth,markedDates,des);
        dates.push(...markedDates);
        dess.push(...des);
    // تولید تقویم در بارگذاری صفحه
      //generateCalendar(currentYear, currentMonth,markedDates,des);
            });
        }
        function deleteTransaction(businessIndex, buttonElement) {
            // پیدا کردن المان والد که حاوی اطلاعات تراکنش است
            const transactionDiv = buttonElement.closest('.log');
            // استخراج اندیس تراکنش از ویژگی داده data-index
            const transactionIndex = parseInt(transactionDiv.getAttribute('data-index'));
            // حذف تراکنش از آرایه
            businesses[businessIndex].transactions.splice(transactionIndex, 1);
            // به‌روزرسانی نمایش کسب‌وکارها
            saveData();
            renderBusinesses();
        }
        function scrollToBusiness(index) {
            const chartElement = document.getElementById(`spammm${index}`);
            chartElement.scrollIntoView({ behavior: 'smooth' });
        }
    const todayGregorian = new Date();
    const todayJ = jalaali.toJalaali(
      todayGregorian.getFullYear(),
      todayGregorian.getMonth() + 1,
      todayGregorian.getDate()
    );
    // استفاده از ماه و سال جاری شمسی
    let currentYear = todayJ.jy;
    let currentMonth = todayJ.jm; // ماه از 1 تا 12

    // تابع ساخت تقویم برای ماه و سال مشخص
    function generateCalendar(year, month,data,des) {
      // تعیین تعداد روزهای ماه بر اساس ماه شمسی
      let daysInMonth;
      if (month <= 6) {
        daysInMonth = 31;
      } else if (month <= 11) {
        daysInMonth = 30;
      } else {
        daysInMonth = jalaali.isLeapJalaaliYear(year) ? 30 : 29;
      }
      
      // محاسبه روز هفته اولین روز ماه
      const gDate = jalaali.toGregorian(year, month, 1);
      const firstDayDate = new Date(gDate.gy, gDate.gm - 1, gDate.gd);
      let jsDay = firstDayDate.getDay(); // 0 (یکشنبه) تا 6 (شنبه)
      // تنظیم شروع هفته؛ در تقویم فارسی شنبه اولین روز هفته است:
      let startIndex = (jsDay + 1) % 7;
      
      // پاکسازی تقویم قدیمی
      const calendarBody = document.getElementById("calendarBody");
      calendarBody.innerHTML = "";

      // نمایش عنوان ماه و سال
      document.getElementById("monthYear").innerText =
        year + "/" + (month < 10 ? "0" + month : month);

      let row = document.createElement("tr");
      // ایجاد سلول‌های خالی برای روزهایی که قبل از اولین روز ماه هستند
      for (let i = 0; i < startIndex; i++) {
        let cell = document.createElement("td");
        cell.innerText = "";
        row.appendChild(cell);
      }
      // پر کردن سلول‌های روزهای ماه
      for (let day = 1; day <= daysInMonth; day++) {
        if (row.children.length === 7) {
          calendarBody.appendChild(row);
          row = document.createElement("tr");
        }
        let cell = document.createElement("td");
        cell.innerText = day;
        // فرمت‌دهی تاریخ به صورت "YYYY/MM/DD"
        let dayString = day < 10 ? "0" + day : day;
        let monthString = month < 10 ? "0" + month : month;
        let dateStr = year + "/" + monthString + "/" + dayString;

        // اگر تاریخ در آرایه markedDates وجود داشته باشد، هایلایت و کلیک اضافه می‌شود
        if (data.includes(dateStr)) {
          let index = data.indexOf(dateStr);
          //cell.classList.add("marked");
          let status = checkFutureDate(dateStr);
          if (status){
            showNotification("صورت حساب های آینده :" + dateStr + "\n" + des[index]);
            cell.classList.add("mark"); 
          }
          else{
            cell.classList.add("marked"); 
          }
          cell.onclick = function() {
            openModal("رویداد ویژه برای تاریخ " + dateStr + "\n" + des[index]);
          }
        }

        // مشخص کردن امروز (اگر تاریخ با تاریخ امروز مطابقت داشته باشد)
        if (year === todayJ.jy && month === todayJ.jm && day === todayJ.jd) {
          cell.classList.add("today");
        }

        row.appendChild(cell);
      }
      // پر کردن سلول‌های خالی انتهای ردیف (در صورت نیاز)
      while (row.children.length < 7) {
        let cell = document.createElement("td");
        cell.innerText = "";
        row.appendChild(cell);
      }
      calendarBody.appendChild(row);

    }

    // دکمه‌های ناوبری:
    function previousMonth() {
      currentMonth--;
      if (currentMonth < 1) {
        currentMonth = 12;
        currentYear--;
      }
      generateCalendar(currentYear, currentMonth,dates,dess);  
      renderBusinesses();
    }
    function nextMonth() {
      currentMonth++;
      if (currentMonth > 12) {
        currentMonth = 1;
          currentYear++;
      }
      generateCalendar(currentYear, currentMonth,dates,dess);  
      renderBusinesses();
    }
    function previousYear() {
      currentYear--;
      generateCalendar(currentYear, currentMonth,dates,dess);  
      renderBusinesses();
    }
    function nextYear() {
      currentYear++;
      generateCalendar(currentYear, currentMonth,dates,dess);  
      renderBusinesses();
    }

    // تابع برای دریافت آرایه تاریخ‌ها و هایلایت آن‌ها


    // توابع نمایش و بستن modal
    function openModal(content) {
      document.getElementById("modalContent").innerText = content;
      document.getElementById("modalOverlay").style.display = "block";
      document.getElementById("modal").style.display = "block";
    }
    function closeModal() {
      document.getElementById("modalOverlay").style.display = "none";
      document.getElementById("modal").style.display = "none";
    }
    function checkFutureDate(jalaliDateStr) {
      // تبدیل رشته تاریخ شمسی به شیء moment با فرمت جلالی
      var date = moment(jalaliDateStr, 'jYYYY/jMM/jDD');
      
      // اعتبارسنجی تاریخ ورودی
      if (!date.isValid()) {
        console.log("تاریخ وارد شده معتبر نیست.");
        return;
      }
      
      // مقایسه تاریخ تبدیل‌شده با تاریخ فعلی
      if (date.isAfter(moment())) {
        console.log("تاریخ داده شده در آینده است.");
        return true;
      } else {
        console.log("تاریخ داده شده در آینده نیست.");
        return false;
      }
    }
    function showNotification(message = '🔔 یک اعلان جدید دارید!') {
      // بررسی پشتیبانی مرورگر از Notification API
      if (!('Notification' in window)) {
        console.error('مرورگر شما از نوتیفیکیشن پشتیبانی نمیکند!');
        return;
      }

      // بررسی مجوزهای دسترسی
      if (Notification.permission === 'granted') {
        // اگر مجوز داده شده، مستقیماً نوتیفیکیشن را نشان بده
        new Notification('اعلان جدید :', {
          body: message,
          icon: 'asset/notification-icon.png' // آدرس آیکون اختیاری
        });
      } else if (Notification.permission !== 'denied') {
        // اگر مجوز رد نشده، درخواست مجوز کنیم
        Notification.requestPermission().then(permission => {
          if (permission === 'granted') {
            new Notification('اعلان سیستم', {
              body: message,
              icon: '/notification-icon.png'
            });
          }
        });
      }
}
        function getMonthDifference(date1, date2) {
            const d1 = new Date(date1);
            const d2 = new Date(date2);

            let yearDiff = d2.getFullYear() - d1.getFullYear();
            let monthDiff = d2.getMonth() - d1.getMonth();

            return yearDiff * 12 + monthDiff;
        }
        function getDayDifference(date1, date2) {
            const d1 = new Date(date1);
            const d2 = new Date(date2);
            const diffMs = d2 - d1; // اختلاف برحسب میلی‌ثانیه
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24)); // تبدیل میلی‌ثانیه به روز
            return diffDays;
        }
        //  Doneپروژه فردا شب

        function calculateValue(balance, transactionDate) {
            const rate = 22.5;
            const monthsInYear = 365;
        
            // محاسبه مقدار اولیه
            let result = (balance * rate) / monthsInYear;
            console.log("------------------",transactionDate);
            let transactionTime = new Date(transactionDate);
            // تبدیل تاریخ شمسی به میلادی
            //let transactionTime = convertShamsiToMiladi(transactionDate);
            let now = new Date(); // تاریخ امروز میلادی
        
            // محاسبه اختلاف ماهیانه
            let yearDiff = now.getFullYear() - transactionTime.getFullYear();
            let monthDiff = now.getMonth() - transactionTime.getMonth();
            let totalMonths = getDayDifference(transactionTime,now);
        
        
            console.log("اختلاف ماهیانه:", totalMonths); // باید عدد صحیح باشه
            console.log("مقدار اولیه:", result);
        
            // محاسبه مقدار نهایی
            let finalValue = Math.round(result * totalMonths/100);
            
            return isNaN(finalValue) ? "خطا در محاسبه!" : finalValue;
        }
        
        function showCalculatedValue(balance, transactionDate) {
            let value = calculateValue(balance, transactionDate);
            alert(`مقدار محاسبه شده: ${value} تومان`);
        }
        // اضافه کردن کلیک به لاگ‌ها
        document.addEventListener('DOMContentLoaded', function() {
            let executed = false;
            document.querySelectorAll('.log').forEach(log => {
                         if (executed) return; // اگر قبلاً اجرا شده بود، خروج از تابع
                              executed = true; // علامت می‌زنیم که تابع اجرا شده است
                              let balance = parseFloat(this.getAttribute('data-balance'));
                              let date = this.getAttribute('data-date');
                              showCalculatedValue(balance, date);                      
            });
        });
        renderBusinesses();
        console.log("88888888888888888888888",dates,dess,"999999999999999999");
        generateCalendar(currentYear, currentMonth,dates,dess); 
    </script>
</body>
</html>
